<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自动化扩展 - MyTrader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body class="bg-gray-100 min-h-screen">
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <a href="{% url 'home' %}" class="text-gray-600 hover:text-emerald-600">
                    <i class="fas fa-arrow-left mr-2"></i>返回首页
                </a>
                <h1 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-robot text-emerald-600 mr-2"></i>自动化扩展
                </h1>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- 标签页 -->
        <div class="bg-white rounded-lg shadow-sm mb-6">
            <div class="border-b">
                <nav class="flex -mb-px">
                    <button onclick="showTab('signals')" id="tab-signals" class="tab-btn px-6 py-3 border-b-2 border-emerald-500 text-emerald-600 font-medium">
                        <i class="fas fa-bell mr-2"></i>策略信号
                    </button>
                    <button onclick="showTab('webhooks')" id="tab-webhooks" class="tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-plug mr-2"></i>Webhook
                    </button>
                    <button onclick="showTab('reports')" id="tab-reports" class="tab-btn px-6 py-3 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-envelope mr-2"></i>定时报告
                    </button>
                </nav>
            </div>

            <!-- 策略信号 -->
            <div id="panel-signals" class="tab-panel p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium">策略信号记录</h3>
                    <button onclick="loadSignals()" class="text-sm text-emerald-600 hover:text-emerald-700">
                        <i class="fas fa-sync-alt mr-1"></i>刷新
                    </button>
                </div>
                <div id="signals-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-gray-500 text-center py-4">加载中...</p>
                </div>
            </div>

            <!-- Webhook -->
            <div id="panel-webhooks" class="tab-panel p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium">Webhook配置</h3>
                    <button onclick="showWebhookModal()" class="text-sm bg-emerald-500 text-white px-3 py-1 rounded hover:bg-emerald-600">
                        <i class="fas fa-plus mr-1"></i>新建
                    </button>
                </div>
                <div id="webhooks-list" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">加载中...</p>
                </div>

                <div class="mt-6 p-4 bg-blue-50 rounded-lg">
                    <h4 class="font-medium text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Webhook使用说明</h4>
                    <p class="text-sm text-blue-700 mb-2">创建"接收信号"类型的Webhook后，外部系统可以通过POST请求发送交易信号：</p>
                    <code class="block bg-white p-2 rounded text-xs text-gray-700">
POST /api/webhook/{secret_key}/<br>
Content-Type: application/json<br><br>
{"symbol": "000001", "action": "buy", "price": 10.5, "quantity": 100, "message": "突破信号"}
                    </code>
                </div>
            </div>

            <!-- 定时报告 -->
            <div id="panel-reports" class="tab-panel p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium">定时报告配置</h3>
                    <button onclick="showReportModal()" class="text-sm bg-emerald-500 text-white px-3 py-1 rounded hover:bg-emerald-600">
                        <i class="fas fa-plus mr-1"></i>新建
                    </button>
                </div>
                <div id="reports-list" class="space-y-3">
                    <p class="text-gray-500 text-center py-4">加载中...</p>
                </div>

                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-yellow-50 rounded-lg">
                        <h4 class="font-medium text-yellow-800 mb-2"><i class="fas fa-exclamation-triangle mr-2"></i>邮件配置</h4>
                        <p class="text-sm text-yellow-700">定时报告需要配置SMTP邮件服务器。请在settings.py中配置EMAIL_HOST等参数。</p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-800 mb-2"><i class="fas fa-paper-plane mr-2"></i>测试邮件</h4>
                        <div class="flex space-x-2">
                            <input type="email" id="test-email" placeholder="输入邮箱" class="flex-1 px-3 py-2 border rounded text-sm">
                            <button onclick="sendTestEmail()" class="px-3 py-2 bg-gray-600 text-white rounded text-sm hover:bg-gray-700">发送</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Webhook弹窗 -->
    <div id="webhook-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-medium mb-4">新建Webhook</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">名称</label>
                    <input type="text" id="webhook-name" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">类型</label>
                    <select id="webhook-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="inbound">接收信号（外部系统推送到MyTrader）</option>
                        <option value="outbound">发送通知（MyTrader推送到外部系统）</option>
                    </select>
                </div>
                <div id="webhook-url-group" class="hidden">
                    <label class="block text-sm text-gray-600 mb-1">目标URL</label>
                    <input type="url" id="webhook-url" placeholder="https://..." class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">描述</label>
                    <textarea id="webhook-desc" rows="2" class="w-full px-3 py-2 border rounded-lg"></textarea>
                </div>
                <div class="flex space-x-3">
                    <button onclick="hideWebhookModal()" class="flex-1 py-2 border rounded-lg hover:bg-gray-50">取消</button>
                    <button onclick="createWebhook()" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 报告弹窗 -->
    <div id="report-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <h3 class="text-lg font-medium mb-4">新建定时报告</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-600 mb-1">报告名称</label>
                    <input type="text" id="report-name" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">报告类型</label>
                    <select id="report-type" class="w-full px-3 py-2 border rounded-lg">
                        <option value="trade_summary">交易总结</option>
                        <option value="performance">绩效报告</option>
                        <option value="risk_report">风险报告</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">频率</label>
                        <select id="report-frequency" class="w-full px-3 py-2 border rounded-lg" onchange="updateSendDayLabel()">
                            <option value="daily">每日</option>
                            <option value="weekly">每周</option>
                            <option value="monthly">每月</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm text-gray-600 mb-1">发送时间</label>
                        <input type="time" id="report-time" value="08:00" class="w-full px-3 py-2 border rounded-lg">
                    </div>
                </div>
                <div id="send-day-group" class="hidden">
                    <label id="send-day-label" class="block text-sm text-gray-600 mb-1">发送日</label>
                    <input type="number" id="report-day" value="1" min="1" max="31" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm text-gray-600 mb-1">接收邮箱</label>
                    <input type="email" id="report-email" class="w-full px-3 py-2 border rounded-lg">
                </div>
                <div class="flex space-x-3">
                    <button onclick="hideReportModal()" class="flex-1 py-2 border rounded-lg hover:bg-gray-50">取消</button>
                    <button onclick="createReport()" class="flex-1 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600">创建</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function getCsrfToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // 标签页切换
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-emerald-500', 'text-emerald-600');
                btn.classList.add('border-transparent', 'text-gray-500');
            });
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.add('hidden'));

            document.getElementById(`tab-${tab}`).classList.add('border-emerald-500', 'text-emerald-600');
            document.getElementById(`tab-${tab}`).classList.remove('border-transparent', 'text-gray-500');
            document.getElementById(`panel-${tab}`).classList.remove('hidden');
        }

        // 策略信号
        function loadSignals() {
            fetch('/api/signals/')
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('signals-list');
                    if (data.signals.length === 0) {
                        list.innerHTML = '<p class="text-gray-500 text-center py-4">暂无策略信号</p>';
                        return;
                    }
                    let html = '';
                    data.signals.forEach(s => {
                        const typeColors = {
                            'buy': 'bg-green-100 text-green-800',
                            'sell': 'bg-red-100 text-red-800',
                            'hold': 'bg-gray-100 text-gray-800'
                        };
                        const typeClass = typeColors[s.signal_type] || 'bg-gray-100';
                        html += `<div class="p-3 border rounded-lg flex justify-between items-center">
                            <div>
                                <span class="font-medium">${s.symbol}</span>
                                <span class="text-xs px-2 py-0.5 rounded ml-2 ${typeClass}">${s.signal_type_display}</span>
                                <span class="text-xs text-gray-400 ml-2">${s.source}</span>
                                <br><span class="text-sm text-gray-600">${s.strategy_name}</span>
                                ${s.price ? `<span class="text-sm text-gray-500 ml-2">@ ${s.price}</span>` : ''}
                            </div>
                            <div class="text-right">
                                <span class="text-xs text-gray-400">${s.created_at}</span>
                                ${s.is_notified ? '<br><span class="text-xs text-green-500"><i class="fas fa-check"></i> 已通知</span>' : ''}
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                });
        }

        // Webhook
        function loadWebhooks() {
            fetch('/api/webhooks/')
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('webhooks-list');
                    if (data.webhooks.length === 0) {
                        list.innerHTML = '<p class="text-gray-500 text-center py-4">暂无Webhook配置</p>';
                        return;
                    }
                    let html = '';
                    data.webhooks.forEach(w => {
                        const statusClass = w.status === 'active' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600';
                        html += `<div class="p-4 border rounded-lg">
                            <div class="flex justify-between items-start">
                                <div>
                                    <span class="font-medium">${w.name}</span>
                                    <span class="text-xs px-2 py-0.5 rounded ml-2 ${statusClass}">${w.status === 'active' ? '启用' : '停用'}</span>
                                    <span class="text-xs px-2 py-0.5 rounded ml-1 bg-blue-100 text-blue-800">${w.webhook_type_display}</span>
                                </div>
                                <button onclick="deleteWebhook(${w.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                            <div class="mt-2 text-sm">
                                <p class="text-gray-500">密钥: <code class="bg-gray-100 px-1 rounded">${w.secret_key}</code></p>
                                ${w.webhook_type === 'inbound' ? `<p class="text-gray-500 mt-1">接收URL: <code class="bg-gray-100 px-1 rounded text-xs">${window.location.origin}/api/webhook/${w.secret_key}/</code></p>` : ''}
                                <p class="text-gray-400 text-xs mt-1">触发次数: ${w.trigger_count} ${w.last_triggered ? `| 最后触发: ${w.last_triggered}` : ''}</p>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                });
        }

        function showWebhookModal() {
            document.getElementById('webhook-modal').classList.remove('hidden');
        }

        function hideWebhookModal() {
            document.getElementById('webhook-modal').classList.add('hidden');
        }

        document.getElementById('webhook-type').addEventListener('change', function() {
            document.getElementById('webhook-url-group').classList.toggle('hidden', this.value !== 'outbound');
        });

        function createWebhook() {
            const data = {
                name: document.getElementById('webhook-name').value,
                webhook_type: document.getElementById('webhook-type').value,
                url: document.getElementById('webhook-url').value,
                description: document.getElementById('webhook-desc').value,
            };

            fetch('/api/webhooks/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    alert(`创建成功！\n密钥: ${result.secret_key}`);
                    hideWebhookModal();
                    loadWebhooks();
                }
            });
        }

        function deleteWebhook(id) {
            if (!confirm('确定删除此Webhook？')) return;
            fetch(`/api/webhooks/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            }).then(() => loadWebhooks());
        }

        // 定时报告
        function loadReports() {
            fetch('/api/reports/')
                .then(res => res.json())
                .then(data => {
                    const list = document.getElementById('reports-list');
                    if (data.reports.length === 0) {
                        list.innerHTML = '<p class="text-gray-500 text-center py-4">暂无定时报告</p>';
                        return;
                    }
                    let html = '';
                    data.reports.forEach(r => {
                        const statusClass = r.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-600';
                        html += `<div class="p-4 border rounded-lg flex justify-between items-center">
                            <div>
                                <span class="font-medium">${r.name}</span>
                                <span class="text-xs px-2 py-0.5 rounded ml-2 ${statusClass}">${r.is_active ? '启用' : '停用'}</span>
                                <br><span class="text-sm text-gray-500">${r.report_type_display} | ${r.frequency_display} ${r.send_time}</span>
                                <br><span class="text-xs text-gray-400">${r.email}</span>
                            </div>
                            <div class="flex space-x-2">
                                <button onclick="toggleReport(${r.id})" class="text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-${r.is_active ? 'pause' : 'play'}"></i>
                                </button>
                                <button onclick="deleteReport(${r.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>`;
                    });
                    list.innerHTML = html;
                });
        }

        function showReportModal() {
            document.getElementById('report-modal').classList.remove('hidden');
        }

        function hideReportModal() {
            document.getElementById('report-modal').classList.add('hidden');
        }

        function updateSendDayLabel() {
            const freq = document.getElementById('report-frequency').value;
            const group = document.getElementById('send-day-group');
            const label = document.getElementById('send-day-label');
            if (freq === 'daily') {
                group.classList.add('hidden');
            } else {
                group.classList.remove('hidden');
                label.textContent = freq === 'weekly' ? '每周几 (1=周一)' : '每月几号';
            }
        }

        function createReport() {
            const data = {
                name: document.getElementById('report-name').value,
                report_type: document.getElementById('report-type').value,
                frequency: document.getElementById('report-frequency').value,
                send_time: document.getElementById('report-time').value,
                send_day: parseInt(document.getElementById('report-day').value),
                email: document.getElementById('report-email').value,
            };

            fetch('/api/reports/create/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                if (result.error) {
                    alert(result.error);
                } else {
                    hideReportModal();
                    loadReports();
                }
            });
        }

        function toggleReport(id) {
            fetch(`/api/reports/${id}/toggle/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            }).then(() => loadReports());
        }

        function deleteReport(id) {
            if (!confirm('确定删除此报告？')) return;
            fetch(`/api/reports/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
            }).then(() => loadReports());
        }

        function sendTestEmail() {
            const email = document.getElementById('test-email').value;
            if (!email) {
                alert('请输入邮箱地址');
                return;
            }

            fetch('/api/reports/test/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': getCsrfToken() },
                body: JSON.stringify({ email })
            })
            .then(res => res.json())
            .then(result => {
                alert(result.message || result.error);
            });
        }

        // 初始化
        loadSignals();
        loadWebhooks();
        loadReports();
    </script>
</body>
</html>
