# 量化交易模块使用指南

## 目录

1. [快速开始](#快速开始)
2. [数据管理](#数据管理)
3. [策略配置](#策略配置)
4. [执行回测](#执行回测)
5. [查看结果](#查看结果)
6. [定时任务](#定时任务)
7. [API 参考](#api-参考)

---

## 快速开始

### 1. 启动必要服务

```bash
# 启动 Redis（Celery 消息队列需要）
redis-server

# 启动 Django 开发服务器
.venv/bin/python manage.py runserver

# 启动 Celery Worker（处理异步任务）
celery -A mytrader worker -l info

# 启动 Celery Beat（定时任务调度，可选）
celery -A mytrader beat -l info
```

### 2. 下载股票数据

**方式一：Web 界面（推荐）**

1. 访问 http://127.0.0.1:8000/quant/data/
2. 输入股票代码（如 `000001 600519 300750`）
3. 选择日期范围
4. 点击"开始下载"

**方式二：命令行**

```bash
# 下载单只股票一年数据
python manage.py fetch_stock_data --symbols 000001

# 下载多只股票
python manage.py fetch_stock_data --symbols 000001 600519 300750

# 指定日期范围
python manage.py fetch_stock_data --symbols 000001 --start 20230101 --end 20231231

# 使用后复权（默认前复权）
python manage.py fetch_stock_data --symbols 000001 --adjust hfq
```

### 3. 创建策略

在 Django Admin 后台创建策略：

1. 访问 http://127.0.0.1:8000/admin/
2. 进入 **Quant → 量化策略**
3. 点击 **添加量化策略**
4. 填写信息：
   - 所有者：选择用户
   - 策略名称：如 "均线交叉策略"
   - 策略类型：选择类型
   - 策略参数（JSON）：`{"fast_period": 5, "slow_period": 20}`
   - 交易标的：`["000001", "600519"]`
   - 初始资金：100000

### 4. 执行回测

访问回测页面：
```
http://127.0.0.1:8000/quant/strategy/1/backtest/
```

或使用命令行：
```python
python manage.py shell

from datetime import date
from quant.backtest_service import run_backtest

result = run_backtest(
    strategy_id=1,
    symbol='000001',
    start_date=date(2024, 1, 1),
    end_date=date(2024, 12, 31),
    initial_capital=100000
)

print(f'总收益率: {result.total_return}%')
print(f'夏普比率: {result.sharpe_ratio}')
print(f'最大回撤: {result.max_drawdown}%')
```

---

## 数据管理

### Web 界面管理（推荐）

访问股票数据管理页面：
```
http://127.0.0.1:8000/quant/data/
```

或从首页侧边栏进入：**量化交易 → 股票数据**

**功能特性：**

1. **数据统计**：显示已下载的股票数量和数据条数

2. **批量下载**：
   - 在文本框输入股票代码（支持空格、逗号、换行分隔）
   - 选择日期范围（默认最近一年）
   - 点击"开始下载"
   - 实时显示下载进度

3. **快捷选择**：点击常用股票标签快速添加
   - 平安银行 (000001)
   - 贵州茅台 (600519)
   - 宁德时代 (300750)
   - 五粮液 (000858)
   - 中国平安 (601318)

4. **数据管理**：
   - 查看每只股票的数据条数、起止日期
   - 一键删除指定股票的所有数据

**使用示例：**

```
1. 访问 /quant/data/
2. 在文本框输入：000001 600519 300750
3. 选择日期：2024-01-01 至 2024-12-31
4. 点击"开始下载"
5. 等待任务完成，页面自动刷新显示新数据
```

### 命令行下载数据

```bash
# 基本用法
python manage.py fetch_stock_data --symbols <股票代码>

# 参数说明
--symbols     股票代码列表（必填），如 000001 600519
--start       开始日期，格式 YYYYMMDD，默认一年前
--end         结束日期，格式 YYYYMMDD，默认今天
--adjust      复权类型：qfq(前复权,默认) / hfq(后复权) / 空(不复权)
```

### Python API 下载数据

```python
from quant.data_fetcher import StockDataFetcher, fetch_stock_data

# 方式1：使用便捷函数
fetch_stock_data('000001', '20240101', '20241231')

# 方式2：使用类
fetcher = StockDataFetcher(adjust='qfq')
fetcher.fetch('000001', '20240101', '20241231', save_to_db=True)

# 获取今日数据
fetcher.fetch_today('000001')

# 获取最近N个交易日
fetcher.fetch_latest('000001', days=5)
```

### 交易日历

```python
from quant.data_fetcher import is_trade_date, get_trade_dates, TradingCalendar

# 判断今天是否为交易日
if is_trade_date():
    print("今天是交易日")

# 判断指定日期
is_trade_date(date(2024, 10, 1))  # False（国庆节）

# 获取日期范围内的交易日
trade_days = get_trade_dates('20240101', '20240131')

# 获取最近交易日
last_trade_day = TradingCalendar.get_last_trade_date()

# 获取下一个交易日
next_trade_day = TradingCalendar.get_next_trade_date()
```

---

## 策略配置

### 策略类型

| 类型 | 代码 | 说明 |
|------|------|------|
| 均线交叉 | ma_cross | 快慢均线交叉策略 |
| 动量策略 | momentum | 基于价格动量 |
| 均值回归 | mean_reversion | 价格回归均值 |
| 突破策略 | breakout | 价格突破关键位 |
| 配对交易 | pair_trading | 两只股票配对 |
| 网格交易 | grid | 网格买卖 |
| 自定义 | custom | 自定义策略 |

### 策略参数示例

**均线交叉策略：**
```json
{
  "fast_period": 5,
  "slow_period": 20
}
```

**动量策略：**
```json
{
  "lookback_period": 20,
  "threshold": 0.05
}
```

### 策略状态

| 状态 | 说明 |
|------|------|
| draft | 草稿，未启用 |
| active | 运行中 |
| paused | 已暂停 |
| stopped | 已停止 |

---

## 执行回测

### Web 界面

1. 访问策略回测页面：`/quant/strategy/<策略ID>/backtest/`
2. 选择股票代码、日期范围、初始资金
3. 点击"开始回测"
4. 等待任务完成，自动跳转到结果页面

### Python API

```python
from datetime import date
from quant.backtest_service import run_backtest, BacktestService

# 方式1：便捷函数
result = run_backtest(
    strategy_id=1,
    symbol='000001',
    start_date=date(2024, 1, 1),
    end_date=date(2024, 12, 31),
    initial_capital=100000,
    slippage=0.001,      # 滑点 0.1%
    check_limit=True,    # 检查涨跌停
    fast_period=5,       # 策略参数
    slow_period=20
)

# 方式2：使用服务类
service = BacktestService(strategy_id=1, initial_capital=100000)
result = service.run(
    symbol='000001',
    start_date=date(2024, 1, 1),
    end_date=date(2024, 12, 31)
)
```

### 回测参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| strategy_id | int | 必填 | 策略ID |
| symbol | str | 必填 | 股票代码 |
| start_date | date | 必填 | 开始日期 |
| end_date | date | 必填 | 结束日期 |
| initial_capital | int | 100000 | 初始资金 |
| slippage | float | 0.001 | 滑点比例 |
| check_limit | bool | True | 是否检查涨跌停 |

### 回测特性

**A股特性模拟：**
- ✅ T+1 交易规则（买入当天不能卖出）
- ✅ 佣金：万三，最低5元
- ✅ 印花税：千一（仅卖出）
- ✅ 滑点模拟（默认0.1%）
- ✅ 涨跌停限制（主板10%，科创板/创业板20%）

---

## 查看结果

### 回测结果指标

| 指标 | 说明 |
|------|------|
| total_return | 总收益率（%） |
| annual_return | 年化收益率（%） |
| sharpe_ratio | 夏普比率 |
| max_drawdown | 最大回撤（%） |
| max_drawdown_duration | 最大回撤持续天数 |
| win_rate | 胜率（%） |
| profit_factor | 盈亏比 |
| total_trades | 总交易次数 |
| winning_trades | 盈利次数 |
| losing_trades | 亏损次数 |

### 查看回测详情

```python
from quant.models import BacktestResult

# 获取回测结果
result = BacktestResult.objects.get(id=1)

# 基本指标
print(f'总收益率: {result.total_return}%')
print(f'夏普比率: {result.sharpe_ratio}')
print(f'最大回撤: {result.max_drawdown}%')
print(f'胜率: {result.win_rate}%')
print(f'净利润: {result.net_profit}')

# 权益曲线（每日净值）
for point in result.equity_curve:
    print(f"{point['date']}: {point['value']}")

# 交易明细
for trade in result.trades_data:
    print(f"{trade['entry_date']} 买入 -> {trade['exit_date']} 卖出, 盈亏: {trade['pnl']}")
```

### Web 页面

- 回测列表：`/quant/strategy/<策略ID>/backtest/`
- 回测详情：`/quant/backtest/<回测ID>/`

---

## 定时任务

### 配置每日数据更新

**方式1：Django Admin**

1. 访问 `/admin/django_celery_beat/periodictask/`
2. 添加定时任务：
   - 名称：每日K线更新
   - 任务：`quant.tasks.update_daily_kline`
   - 计划类型：Crontab
   - Crontab：`0 16 * * 1-5`（周一至周五16:00）

**方式2：Crontab**

```bash
# 编辑 crontab
crontab -e

# 添加任务（每个交易日16:00执行）
0 16 * * 1-5 cd /path/to/mytrader && .venv/bin/celery -A mytrader call quant.tasks.update_daily_kline
```

### 手动触发任务

```python
from quant.tasks import update_daily_kline, fetch_stock_history

# 更新所有已有股票的今日数据
update_daily_kline.delay()

# 更新指定股票
update_daily_kline.delay(symbols=['000001', '600519'])

# 异步下载历史数据
fetch_stock_history.delay('000001', '20240101', '20241231')
```

---

## API 参考

### 数据模型

**StockData - 股票日线数据**
```python
StockData.objects.filter(symbol='000001', date__gte='2024-01-01')
```

**Strategy - 量化策略**
```python
Strategy.objects.filter(owner=user, status='active')
```

**BacktestResult - 回测结果**
```python
BacktestResult.objects.filter(strategy_id=1).order_by('-created_at')
```

**TradeOrder - 委托单**
```python
TradeOrder.objects.filter(strategy_id=1, status='filled')
```

### Celery 任务

| 任务 | 说明 |
|------|------|
| `update_daily_kline` | 更新每日K线（自动检查交易日） |
| `fetch_stock_history` | 异步下载历史数据 |
| `run_backtest_task` | 异步执行回测 |

### URL 路由

| URL | 说明 |
|-----|------|
| `/quant/data/` | 股票数据管理页面 |
| `/quant/data/fetch/` | 下载股票数据 API |
| `/quant/data/task/<task_id>/` | 查询下载任务状态 |
| `/quant/data/delete/` | 删除股票数据 API |
| `/quant/strategy/<id>/backtest/` | 策略回测列表 |
| `/quant/backtest/<id>/` | 回测详情 |
| `/quant/backtest/trigger/` | 触发回测 API |
| `/quant/backtest/task/<task_id>/` | 查询回测任务状态 |

---

## 常见问题

### Q: 如何快速下载股票数据？

A: 推荐使用 Web 界面：
1. 访问 http://127.0.0.1:8000/quant/data/
2. 输入股票代码，选择日期范围
3. 点击"开始下载"

或从首页侧边栏：**量化交易 → 股票数据**

### Q: 回测时提示"无数据"？

A: 需要先下载股票数据：
```bash
python manage.py fetch_stock_data --symbols 000001 --start 20240101
```

### Q: Celery 任务不执行？

A: 检查 Redis 和 Celery Worker 是否启动：
```bash
redis-server
celery -A mytrader worker -l info
```

### Q: 如何自定义策略？

A: 继承 `bt.Strategy` 创建自定义策略类：
```python
from quant.backtest_service import SimpleMACrossStrategy, LimitChecker
import backtrader as bt

class MyStrategy(bt.Strategy):
    params = (('period', 20),)

    def __init__(self):
        self.sma = bt.indicators.SMA(self.data.close, period=self.p.period)

    def next(self):
        if self.data.close[0] > self.sma[0]:
            self.buy()
        elif self.data.close[0] < self.sma[0]:
            self.sell()

# 使用自定义策略
from quant.backtest_service import BacktestService
service = BacktestService(strategy_id=1)
result = service.run('000001', start_date, end_date, strategy_class=MyStrategy)
```

### Q: 如何关闭涨跌停检查？

A: 设置 `check_limit=False`：
```python
result = run_backtest(..., check_limit=False)
```

### Q: 如何调整滑点？

A: 设置 `slippage` 参数：
```python
result = run_backtest(..., slippage=0.002)  # 0.2% 滑点
result = run_backtest(..., slippage=0)      # 无滑点
```

---

*MyTrader 量化交易模块 © 2025*
